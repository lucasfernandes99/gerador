<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerador de QR Codes - Controle de Festa</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    background: #f7f7f7;
  }
  h1 {
    background: #007bff;
    color: white;
    padding: 15px;
    margin: 0;
  }
  .botoes {
    margin: 15px;
  }
  button {
    margin: 5px;
    padding: 10px 14px;
    border: none;
    border-radius: 6px;
    background: #007bff;
    color: white;
    font-size: 1rem;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  #status {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin: 15px 0;
  }
  .card {
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    min-width: 100px;
  }
  .gerados { background: #28a745; }
  .atualizados { background: #007bff; }
  .total { background: #6c757d; }
  #qrcodes {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin-bottom: 40px;
  }
  .qr-item {
    background: #fff;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    text-align: center;
    font-size: 14px;
    width: 150px;
  }
</style>
</head>
<body>
<h1>üéâ Gerador de QR Codes - Controle de Festa</h1>

<div class="botoes">
  <input type="file" id="excelFile" accept=".xlsx">
  <button onclick="gerarQRCodes()">Gerar / Atualizar</button>
  <button onclick="atualizarSemArquivo()">üîÅ Atualizar lista</button>
  <button onclick="recriarTodos()">‚ôªÔ∏è Recriar Todos</button>
  <button onclick="exportarJPEGs()">üì∏ Exportar JPEGs</button>
  <button onclick="baixarJSON()">üíæ Baixar JSON</button>
</div>

<div id="status">
  <div class="card gerados" id="gerados">Gerados: 0</div>
  <div class="card atualizados" id="atualizados">Atualizados: 0</div>
  <div class="card total" id="total">Total: 0</div>
</div>

<div id="qrcodes"></div>

<script>
let familias = JSON.parse(localStorage.getItem('familias')) || [];
let ultimaPlanilha = null;

document.getElementById('excelFile').addEventListener('change', lerPlanilha);

function lerPlanilha(event) {
  const file = event.target.files[0];
  if (!file) return alert("Selecione um arquivo Excel!");
  ultimaPlanilha = file;
  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    atualizarLista(json);
  };
  reader.readAsArrayBuffer(file);
}

function atualizarLista(json) {
  const antigas = new Map(familias.map(f => [f.id, f]));
  let gerados = 0, atualizados = 0;

  json.forEach(f => {
    const id = f["Nome da Fam√≠lia"].replace(/\s+/g, '_').toUpperCase();
    const existente = antigas.get(id);

    if (existente) {
      existente.adultos = f["Adultos"] || existente.adultos;
      existente.criancas = f["Crian√ßas"] || existente.criancas;
      atualizados++;
    } else {
      familias.push({
        id,
        nome: f["Nome da Fam√≠lia"],
        adultos: f["Adultos"] || 0,
        criancas: f["Crian√ßas"] || 0,
        entrou: false
      });
      gerados++;
    }
  });

  localStorage.setItem('familias', JSON.stringify(familias));
  exibirQRCodes();
  atualizarStatus(gerados, atualizados);
}

function atualizarSemArquivo() {
  if (!ultimaPlanilha) return alert("Nenhuma planilha carregada ainda!");
  lerPlanilha({ target: { files: [ultimaPlanilha] } });
}

function gerarQRCodes() {
  const file = document.getElementById('excelFile').files[0];
  if (!file) return alert("Selecione uma planilha para gerar QR Codes!");
  lerPlanilha({ target: { files: [file] } });
}

function exibirQRCodes() {
  const container = document.getElementById("qrcodes");
  container.innerHTML = "";
  familias.forEach(f => {
    const div = document.createElement("div");
    div.className = "qr-item";

    const label = document.createElement("div");
    label.innerHTML = `<strong>${f.nome}</strong><br>${f.adultos} adultos e ${f.criancas} crian√ßas`;
    div.appendChild(label);

    const qrDiv = document.createElement("div");
    new QRCode(qrDiv, { text: f.id, width: 128, height: 128 });
    div.appendChild(qrDiv);
    container.appendChild(div);
  });
  atualizarStatus(0, 0);
}

function atualizarStatus(gerados, atualizados) {
  document.getElementById("gerados").innerText = `Gerados: ${gerados}`;
  document.getElementById("atualizados").innerText = `Atualizados: ${atualizados}`;
  document.getElementById("total").innerText = `Total: ${familias.length}`;
}

function baixarJSON() {
  if (!familias.length) return alert("Nenhum dado para salvar!");
  const blob = new Blob([JSON.stringify(familias, null, 2)], { type: "application/json" });
  saveAs(blob, "familias.json");
}

async function exportarJPEGs() {
  if (!familias.length) return alert("Gere os QR Codes antes de exportar!");
  const zip = new JSZip();
  const qrDivs = document.querySelectorAll(".qr-item div canvas");
  qrDivs.forEach((canvas, i) => {
    const nome = familias[i].nome.replace(/\s+/g, '_');
    const dataURL = canvas.toDataURL("image/jpeg");
    const base64 = dataURL.split(",")[1];
    zip.file(`${nome}.jpeg`, base64, { base64: true });
  });
  const blob = await zip.generateAsync({ type: "blob" });
  saveAs(blob, "QRCodes_Festa.zip");
  alert("üì¶ QR Codes exportados com sucesso!");
}

function recriarTodos() {
  if (!confirm("Tem certeza que deseja recriar todos os QR Codes do zero?")) return;
  localStorage.removeItem('familias');
  familias = [];
  document.getElementById("qrcodes").innerHTML = "";
  atualizarStatus(0, 0);
  alert("‚úÖ Todos os QR Codes foram apagados. Importe a planilha novamente.");
}

window.onload = exibirQRCodes;
</script>
</body>
</html>
