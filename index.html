<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerador de QR Codes - Festa (Atualizado)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<style>
  body { font-family: Arial; margin: 20px; background: #f5f5f5; }
  h1 { text-align: center; }
  input, button { margin: 5px; padding: 8px; }
  .familia { background: #fff; padding: 10px; margin: 10px 0; border-radius: 8px; }
  #log { background: #eef; padding: 10px; border-radius: 6px; margin-top:10px; }
</style>
</head>
<body>
<h1>üéâ Gerador de QR Code - Festa (Atualizado)</h1>

<p>
  <strong>Planilha (.xlsx)</strong> com colunas obrigat√≥rias: <em>Nome da Fam√≠lia</em>, <em>Adultos</em>, <em>Crian√ßas</em>.<br>
  Coluna opcional: <em>ID</em> (ex: FAM001) ‚Äî se presente, ser√° usada como ID est√°vel.
</p>

<input type="file" id="arquivoExcel" accept=".xlsx">
<button onclick="exportar()">Exportar Dados (.json)</button>
<button onclick="limpar()">Limpar Tudo</button>

<h2>Fam√≠lias Cadastradas:</h2>
<div id="lista"></div>

<div id="log" style="display:none"></div>

<script>
/* -------------------------
   UTILIT√ÅRIOS
   -------------------------*/

// Recupera/guarda no localStorage
let familias = JSON.parse(localStorage.getItem('familias')) || {};

// Normaliza nome: trim, m√∫ltiplos espa√ßos -> 1, remove acentos, toLowerCase
function normalizeName(nome) {
  if (!nome) return '';
  // trim and collapse spaces
  let s = nome.trim().replace(/\s+/g, ' ');
  // remove diacritics (acentos)
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  return s.toLowerCase();
}

// Gera ID a partir de string (hash simples) e garante prefixo FAM
function hashToId(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
    hash = hash | 0;
  }
  const abs = Math.abs(hash);
  const id = 'FAM' + String(abs).padStart(6, '0');
  return id;
}

// Encontra uma fam√≠lia existente por ID ou por nome normalizado
function findExisting(normalizedName, providedId) {
  if (providedId && familias[providedId]) return providedId;

  // pesquisa por normalizedName em familias
  for (const id in familias) {
    const f = familias[id];
    if (f._normalizedName && f._normalizedName === normalizedName) {
      return id;
    }
  }
  return null;
}

/* -------------------------
   IMPORTA√á√ÉO DE PLANILHA
   -------------------------*/

document.getElementById('arquivoExcel').addEventListener('change', function(e) {
  const arquivo = e.target.files[0];
  if (!arquivo) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const sheetName = workbook.SheetNames[0];
      const planilha = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

      let added = 0, updated = 0, skipped = 0;
      planilha.forEach(linha => {
        // Aceita colunas com nomes ligeiramente diferentes: tentar v√°rias op√ß√µes
        const rawName = linha['Nome da Fam√≠lia'] ?? linha['Nome'] ?? linha['Familia'] ?? linha['Family'];
        const adultosRaw = linha['Adultos'] ?? linha['Adults'] ?? linha['adultos'];
        const criancasRaw = linha['Crian√ßas'] ?? linha['Criancas'] ?? linha['Children'] ?? linha['criancas'];
        const providedId = linha['ID'] ?? linha['Id'] ?? linha['id'];

        const nome = (typeof rawName === 'string') ? rawName.trim() : '';
        const adultos = parseInt(adultosRaw);
        const criancas = parseInt(criancasRaw);

        if (!nome || isNaN(adultos) || isNaN(criancas)) { skipped++; return; }

        const normalized = normalizeName(nome);
        // Decide ID: usa ID fornecido se houver, sen√£o hash da normalized
        const candidateId = providedId ? String(providedId).trim() : hashToId(normalized);
        // Tenta encontrar correspond√™ncia por ID ou por normalized name
        const existingId = findExisting(normalized, candidateId);

        if (existingId) {
          // atualizar mantendo entrou
          familias[existingId].nome = nome; // atualiza para o nome atual (formata√ß√£o original)
          familias[existingId].adultos = adultos;
          familias[existingId].criancas = criancas;
          familias[existingId]._normalizedName = normalized;
          updated++;
        } else {
          // cria nova entrada
          const newId = candidateId;
          familias[newId] = {
            id: newId,
            nome: nome,
            adultos: adultos,
            criancas: criancas,
            entrou: false,
            _normalizedName: normalized
          };
          added++;
        }
      });

      localStorage.setItem('familias', JSON.stringify(familias));
      atualizarLista();
      mostrarLog(added, updated, skipped);
      alert(`Importa√ß√£o conclu√≠da. Adicionadas: ${added}, Atualizadas: ${updated}, Ignoradas/Inv√°lidas: ${skipped}`);
    } catch (err) {
      console.error(err);
      alert('Erro ao processar a planilha. Verifique se √© um .xlsx v√°lido e tem as colunas corretas.');
    }
  };
  reader.readAsArrayBuffer(arquivo);
});

/* -------------------------
   UI / Lista / Export / Limpar
   -------------------------*/

function atualizarLista() {
  const container = document.getElementById('lista');
  container.innerHTML = '';
  // ordenar por nome para facilitar
  const lista = Object.values(familias).sort((a,b) => a.nome.localeCompare(b.nome));
  lista.forEach(f => {
    const qr = new QRious({ value: f.id, size: 150 });
    const div = document.createElement('div');
    div.className = 'familia';
    div.innerHTML = `<strong>${f.nome}</strong><br>
                     ${f.adultos} adultos e ${f.criancas} crian√ßas<br>
                     <img src="${qr.toDataURL()}" alt="QR"><br>
                     ID: ${f.id} ${f.entrou ? '<span style="color:green"> (j√° entrou)</span>' : ''}`;
    container.appendChild(div);
  });
}

function exportar() {
  const arr = Object.values(familias).map(f => {
    // n√£o incluir campo _normalizedName no export final
    const { _normalizedName, ...rest } = f;
    return rest;
  });
  const blob = new Blob([JSON.stringify(arr, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'familias.json';
  a.click();
}

function limpar() {
  if (confirm('Tem certeza que deseja apagar tudo? Isso remover√° o hist√≥rico local (IDs e marca√ß√µes de entrada).')) {
    familias = {};
    localStorage.removeItem('familias');
    document.getElementById('lista').innerHTML = '';
    document.getElementById('log').style.display = 'none';
  }
}

function mostrarLog(added, updated, skipped) {
  const log = document.getElementById('log');
  log.style.display = 'block';
  log.innerHTML = `<strong>Resumo da importa√ß√£o</strong><br>
                   Adicionadas: ${added} <br>
                   Atualizadas: ${updated} <br>
                   Ignoradas/Inv√°lidas: ${skipped} <br>
                   Dica: se quiser for√ßar um ID espec√≠fico para uma fam√≠lia, adicione a coluna "ID" na planilha (ex: FAM001).`;
}

/* Ao carregar a p√°gina mostra lista atual */
window.onload = atualizarLista;
</script>
</body>
</html>
