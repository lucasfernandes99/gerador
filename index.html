<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerador de QR Codes - Controle de Festa</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 20px;
    background: #f7f7f7;
  }
  h1 { color: #333; }
  #qrcodes {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
  }
  .qr-item {
    background: #fff;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    text-align: center;
    font-size: 14px;
    width: 150px;
  }
  button {
    margin: 10px;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    background: #007bff;
    color: white;
    font-size: 1rem;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
</style>
</head>
<body>
<h1>üéâ Gerador de QR Codes - Festa</h1>
<input type="file" id="excelFile" accept=".xlsx">
<div>
  <button onclick="gerarQRCodes()">Gerar QR Codes</button>
  <button onclick="baixarJSON()">Baixar Lista (.json)</button>
  <button onclick="exportarJPEGs()">üì∏ Exportar QR Codes em JPEG</button>
</div>
<div id="qrcodes"></div>

<script>
let familias = [];
let qrCodesGerados = [];

document.getElementById('excelFile').addEventListener('change', lerPlanilha);

function lerPlanilha(event) {
  const file = event.target.files[0];
  if (!file) return alert("Selecione um arquivo Excel!");
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    familias = json.map((f, i) => ({
      id: f["Nome da Fam√≠lia"].replace(/\s+/g, '_').toUpperCase(),
      nome: f["Nome da Fam√≠lia"],
      adultos: f["Adultos"] || 0,
      criancas: f["Crian√ßas"] || 0,
      entrou: false
    }));

    alert("‚úÖ Planilha carregada com sucesso!");
  };
  reader.readAsArrayBuffer(file);
}

function gerarQRCodes() {
  if (!familias.length) return alert("Carregue uma planilha primeiro!");
  const container = document.getElementById("qrcodes");
  container.innerHTML = "";
  qrCodesGerados = [];

  familias.forEach(f => {
    const div = document.createElement("div");
    div.className = "qr-item";

    const label = document.createElement("div");
    label.innerHTML = `<strong>${f.nome}</strong><br>${f.adultos} adultos e ${f.criancas} crian√ßas`;
    div.appendChild(label);

    const qrDiv = document.createElement("div");
    div.appendChild(qrDiv);

    const qr = new QRCode(qrDiv, {
      text: f.id,
      width: 128,
      height: 128
    });

    container.appendChild(div);
    qrCodesGerados.push({ nome: f.nome, id: f.id, div: qrDiv });
  });

  alert("üéüÔ∏è QR Codes gerados com sucesso!");
}

function baixarJSON() {
  if (!familias.length) return alert("Nenhum dado para salvar!");
  const blob = new Blob([JSON.stringify(familias, null, 2)], { type: "application/json" });
  saveAs(blob, "familias.json");
}

async function exportarJPEGs() {
  if (!qrCodesGerados.length) return alert("Gere os QR Codes antes de exportar!");
  const zip = new JSZip();

  for (let i = 0; i < qrCodesGerados.length; i++) {
    const { nome, div } = qrCodesGerados[i];
    const canvas = div.querySelector("canvas");
    if (canvas) {
      const dataURL = canvas.toDataURL("image/jpeg");
      const base64 = dataURL.split(",")[1];
      zip.file(`${nome.replace(/\s+/g, '_')}.jpeg`, base64, { base64: true });
    }
  }

  const blob = await zip.generateAsync({ type: "blob" });
  saveAs(blob, "QRCodes_Festa.zip");
  alert("üì¶ Todos os QR Codes foram exportados em JPEG com sucesso!");
}
</script>
</body>
</html>
