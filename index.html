<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerador de QR Codes - Festa (com botÃ£o Reset)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<style>
  body { font-family: Arial; margin: 20px; background: #f5f5f5; }
  h1 { text-align: center; }
  input, button { margin: 5px; padding: 8px; cursor: pointer; }
  .familia { background: #fff; padding: 10px; margin: 10px 0; border-radius: 8px; }
  #log { background: #eef; padding: 10px; border-radius: 6px; margin-top:10px; }
</style>
</head>
<body>
<h1>ğŸ‰ Gerador de QR Code - Festa</h1>

<p>
  Planilha com colunas: <strong>Nome da FamÃ­lia</strong>, <strong>Adultos</strong>, <strong>CrianÃ§as</strong>.<br>
  Coluna opcional: <strong>ID</strong> (para preservar cÃ³digos antigos).
</p>

<input type="file" id="arquivoExcel" accept=".xlsx">
<button onclick="exportar()">ğŸ’¾ Exportar Dados (.json)</button>
<button onclick="limpar()">ğŸ—‘ï¸ Limpar Tudo</button>
<button onclick="resetarQR()">ğŸ” Gerar novos QR Codes do zero</button>

<h2>FamÃ­lias Cadastradas:</h2>
<div id="lista"></div>

<div id="log" style="display:none"></div>

<script>
let familias = JSON.parse(localStorage.getItem('familias')) || {};

function normalizeName(nome) {
  if (!nome) return '';
  let s = nome.trim().replace(/\s+/g, ' ');
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  return s.toLowerCase();
}

function hashToId(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
    hash = hash | 0;
  }
  const abs = Math.abs(hash);
  return 'FAM' + String(abs).padStart(6, '0');
}

function findExisting(normalizedName, providedId) {
  if (providedId && familias[providedId]) return providedId;
  for (const id in familias) {
    if (familias[id]._normalizedName === normalizedName) return id;
  }
  return null;
}

document.getElementById('arquivoExcel').addEventListener('change', function(e) {
  const arquivo = e.target.files[0];
  if (!arquivo) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    const sheet = workbook.SheetNames[0];
    const planilha = XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);

    let added = 0, updated = 0;
    planilha.forEach(linha => {
      const nome = linha['Nome da FamÃ­lia']?.trim();
      const adultos = parseInt(linha['Adultos']);
      const criancas = parseInt(linha['CrianÃ§as']);
      const providedId = linha['ID'];
      if (!nome || isNaN(adultos) || isNaN(criancas)) return;

      const normalized = normalizeName(nome);
      const candidateId = providedId ? String(providedId).trim() : hashToId(normalized);
      const existingId = findExisting(normalized, candidateId);

      if (existingId) {
        familias[existingId].nome = nome;
        familias[existingId].adultos = adultos;
        familias[existingId].criancas = criancas;
        familias[existingId]._normalizedName = normalized;
        updated++;
      } else {
        familias[candidateId] = {
          id: candidateId,
          nome, adultos, criancas, entrou: false, _normalizedName: normalized
        };
        added++;
      }
    });
    localStorage.setItem('familias', JSON.stringify(familias));
    atualizarLista();
    alert(`ImportaÃ§Ã£o concluÃ­da. ${added} novas e ${updated} atualizadas.`);
  };
  reader.readAsArrayBuffer(arquivo);
});

function atualizarLista() {
  const div = document.getElementById('lista');
  div.innerHTML = '';
  const lista = Object.values(familias).sort((a,b)=>a.nome.localeCompare(b.nome));
  lista.forEach(f => {
    const qr = new QRious({ value: f.id, size: 150 });
    const box = document.createElement('div');
    box.className = 'familia';
    box.innerHTML = `<strong>${f.nome}</strong><br>${f.adultos} adultos e ${f.criancas} crianÃ§as<br>
    <img src="${qr.toDataURL()}"><br>ID: ${f.id}`;
    div.appendChild(box);
  });
}

function exportar() {
  const arr = Object.values(familias).map(f => {
    const { _normalizedName, ...clean } = f;
    return clean;
  });
  const blob = new Blob([JSON.stringify(arr, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'familias.json';
  a.click();
}

function limpar() {
  if (confirm('Apagar todos os dados e QR Codes salvos?')) {
    familias = {};
    localStorage.removeItem('familias');
    document.getElementById('lista').innerHTML = '';
  }
}

function resetarQR() {
  if (!confirm('âš ï¸ Isso apagarÃ¡ todos os IDs e gerarÃ¡ novos QR Codes para TODAS as famÃ­lias. Deseja continuar?')) return;

  Object.keys(familias).forEach(id => {
    const f = familias[id];
    const newId = hashToId(f.nome + Date.now() + Math.random());
    f.id = newId;
    f.entrou = false;
  });

  // Reconstruir o dicionÃ¡rio com novos IDs
  const novasFamilias = {};
  Object.values(familias).forEach(f => novasFamilias[f.id] = f);
  familias = novasFamilias;
  localStorage.setItem('familias', JSON.stringify(familias));
  atualizarLista();
  alert('âœ… Todos os QR Codes foram regenerados do zero!');
}

window.onload = atualizarLista;
</script>
</body>
</html>
