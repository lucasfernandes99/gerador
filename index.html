<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerador de QR Codes - Festa</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<style>
  body { font-family: Arial; margin: 20px; background: #f5f5f5; }
  h1 { text-align: center; }
  input, button { margin: 5px; padding: 8px; }
  .familia { background: #fff; padding: 10px; margin: 10px 0; border-radius: 8px; }
</style>
</head>
<body>
<h1>üéâ Gerador de QR Codes - Festa</h1>

<input type="file" id="arquivoExcel" accept=".xlsx">
<button onclick="exportar()">Exportar Dados (.json)</button>
<button onclick="limpar()">Limpar Tudo</button>

<h2>Fam√≠lias Cadastradas:</h2>
<div id="lista"></div>

<script>
let familias = JSON.parse(localStorage.getItem('familias')) || {};

// Fun√ß√£o hash simples baseada no nome (mant√©m QR est√°vel)
function gerarID(nome) {
  let hash = 0;
  for (let i = 0; i < nome.length; i++) {
    hash = nome.charCodeAt(i) + ((hash << 5) - hash);
  }
  return 'FAM' + Math.abs(hash).toString().padStart(6, '0');
}

document.getElementById('arquivoExcel').addEventListener('change', function(e) {
  const arquivo = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    const primeira = workbook.SheetNames[0];
    const planilha = XLSX.utils.sheet_to_json(workbook.Sheets[primeira]);

    planilha.forEach(linha => {
      const nome = linha['Nome da Fam√≠lia']?.trim();
      const qtd = parseInt(linha['Convidados']);
      if (!nome || !qtd) return;

      const id = gerarID(nome);
      if (!familias[id]) {
        familias[id] = { id, nome, qtd, entrou: false };
      } else {
        // Atualiza n√∫mero de convidados caso mude, mas mant√©m ID
        familias[id].qtd = qtd;
      }
    });

    localStorage.setItem('familias', JSON.stringify(familias));
    atualizarLista();
    alert('Planilha importada com sucesso!');
  };
  reader.readAsArrayBuffer(arquivo);
});

function atualizarLista() {
  const container = document.getElementById('lista');
  container.innerHTML = '';
  Object.values(familias).forEach(f => {
    const qr = new QRious({ value: f.id, size: 150 });
    const div = document.createElement('div');
    div.className = 'familia';
    div.innerHTML = `<strong>${f.nome}</strong><br>${f.qtd} convidados<br><img src="${qr.toDataURL()}"><br>ID: ${f.id}`;
    container.appendChild(div);
  });
}

function exportar() {
  const blob = new Blob([JSON.stringify(Object.values(familias), null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'familias.json';
  a.click();
}

function limpar() {
  if (confirm('Tem certeza que deseja apagar tudo?')) {
    familias = {};
    localStorage.removeItem('familias');
    document.getElementById('lista').innerHTML = '';
  }
}

window.onload = atualizarLista;
</script>
</body>
</html>
